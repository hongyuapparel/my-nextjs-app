// 国家代码映射表
export const COUNTRY_CODES: { [key: string]: { nameCN: string, nameEN: string } } = {
  // 数字代码映射
  '840': { nameCN: '美国', nameEN: 'United States' },
  '304': { nameCN: '加拿大', nameEN: 'Canada' },
  '124': { nameCN: '加拿大', nameEN: 'Canada' },
  '276': { nameCN: '德国', nameEN: 'Germany' },
  '250': { nameCN: '法国', nameEN: 'France' },
  '392': { nameCN: '日本', nameEN: 'Japan' },
  '036': { nameCN: '澳大利亚', nameEN: 'Australia' },
  '826': { nameCN: '英国', nameEN: 'United Kingdom' },
  '702': { nameCN: '新加坡', nameEN: 'Singapore' },
  '784': { nameCN: '阿联酋', nameEN: 'UAE' },
  '458': { nameCN: '马来西亚', nameEN: 'Malaysia' },
  '1305': { nameCN: '马来西亚', nameEN: 'Malaysia' },
  '156': { nameCN: '中国', nameEN: 'China' },
  '484': { nameCN: '墨西哥', nameEN: 'Mexico' },
  '076': { nameCN: '巴西', nameEN: 'Brazil' },
  '410': { nameCN: '韩国', nameEN: 'South Korea' },
  '356': { nameCN: '印度', nameEN: 'India' },
  '764': { nameCN: '泰国', nameEN: 'Thailand' },
  '608': { nameCN: '菲律宾', nameEN: 'Philippines' },
  '643': { nameCN: '俄罗斯', nameEN: 'Russia' },
  '348': { nameCN: '匈牙利', nameEN: 'Hungary' },
  '528': { nameCN: '荷兰', nameEN: 'Netherlands' },
  '554': { nameCN: '新西兰', nameEN: 'New Zealand' },
  '752': { nameCN: '瑞典', nameEN: 'Sweden' },
  '616': { nameCN: '波兰', nameEN: 'Poland' },
  '203': { nameCN: '捷克', nameEN: 'Czech Republic' },
  '380': { nameCN: '乌克兰', nameEN: 'Ukraine' },
  '208': { nameCN: '丹麦', nameEN: 'Denmark' },
  '724': { nameCN: '西班牙', nameEN: 'Spain' },
  '756': { nameCN: '瑞士', nameEN: 'Switzerland' },
  '578': { nameCN: '挪威', nameEN: 'Norway' },
  '246': { nameCN: '芬兰', nameEN: 'Finland' },
  '056': { nameCN: '比利时', nameEN: 'Belgium' },

  // 双字母代码映射
  'US': { nameCN: '美国', nameEN: 'United States' },
  'CA': { nameCN: '加拿大', nameEN: 'Canada' },
  'DE': { nameCN: '德国', nameEN: 'Germany' },
  'FR': { nameCN: '法国', nameEN: 'France' },
  'JP': { nameCN: '日本', nameEN: 'Japan' },
  'AU': { nameCN: '澳大利亚', nameEN: 'Australia' },
  'GB': { nameCN: '英国', nameEN: 'United Kingdom' },
  'SG': { nameCN: '新加坡', nameEN: 'Singapore' },
  'AE': { nameCN: '阿联酋', nameEN: 'UAE' },
  'MY': { nameCN: '马来西亚', nameEN: 'Malaysia' },
  'CN': { nameCN: '中国', nameEN: 'China' },
  'MX': { nameCN: '墨西哥', nameEN: 'Mexico' },
  'BR': { nameCN: '巴西', nameEN: 'Brazil' },
  'KR': { nameCN: '韩国', nameEN: 'South Korea' },
  'IN': { nameCN: '印度', nameEN: 'India' },
  'TH': { nameCN: '泰国', nameEN: 'Thailand' },
  'PH': { nameCN: '菲律宾', nameEN: 'Philippines' },
  'RU': { nameCN: '俄罗斯', nameEN: 'Russia' },
  'HU': { nameCN: '匈牙利', nameEN: 'Hungary' },
  'NL': { nameCN: '荷兰', nameEN: 'Netherlands' },
  'NZ': { nameCN: '新西兰', nameEN: 'New Zealand' },
  'SE': { nameCN: '瑞典', nameEN: 'Sweden' },
  'PL': { nameCN: '波兰', nameEN: 'Poland' },
  'CZ': { nameCN: '捷克', nameEN: 'Czech Republic' },
  'UA': { nameCN: '乌克兰', nameEN: 'Ukraine' },
  'DK': { nameCN: '丹麦', nameEN: 'Denmark' },
  'ES': { nameCN: '西班牙', nameEN: 'Spain' },
  'CH': { nameCN: '瑞士', nameEN: 'Switzerland' },
  'NO': { nameCN: '挪威', nameEN: 'Norway' },
  'FI': { nameCN: '芬兰', nameEN: 'Finland' },
  'BE': { nameCN: '比利时', nameEN: 'Belgium' },

  // 三字母代码映射
  'USA': { nameCN: '美国', nameEN: 'United States' },
  'CAN': { nameCN: '加拿大', nameEN: 'Canada' },
  'DEU': { nameCN: '德国', nameEN: 'Germany' },
  'FRA': { nameCN: '法国', nameEN: 'France' },
  'JPN': { nameCN: '日本', nameEN: 'Japan' },
  'AUS': { nameCN: '澳大利亚', nameEN: 'Australia' },
  'GBR': { nameCN: '英国', nameEN: 'United Kingdom' },
  'SGP': { nameCN: '新加坡', nameEN: 'Singapore' },
  'ARE': { nameCN: '阿联酋', nameEN: 'UAE' },
  'MYS': { nameCN: '马来西亚', nameEN: 'Malaysia' },
  'CHN': { nameCN: '中国', nameEN: 'China' },
  'MEX': { nameCN: '墨西哥', nameEN: 'Mexico' },
  'BRA': { nameCN: '巴西', nameEN: 'Brazil' },
  'KOR': { nameCN: '韩国', nameEN: 'South Korea' },
  'IND': { nameCN: '印度', nameEN: 'India' },
  'THA': { nameCN: '泰国', nameEN: 'Thailand' },
  'PHL': { nameCN: '菲律宾', nameEN: 'Philippines' },
  'RUS': { nameCN: '俄罗斯', nameEN: 'Russia' },
  'HUN': { nameCN: '匈牙利', nameEN: 'Hungary' },
  'NLD': { nameCN: '荷兰', nameEN: 'Netherlands' },
  'NZL': { nameCN: '新西兰', nameEN: 'New Zealand' },
  'SWE': { nameCN: '瑞典', nameEN: 'Sweden' },
  'POL': { nameCN: '波兰', nameEN: 'Poland' },
  'CZE': { nameCN: '捷克', nameEN: 'Czech Republic' },
  'UKR': { nameCN: '乌克兰', nameEN: 'Ukraine' },
  'DNK': { nameCN: '丹麦', nameEN: 'Denmark' },
  'ESP': { nameCN: '西班牙', nameEN: 'Spain' },
  'CHE': { nameCN: '瑞士', nameEN: 'Switzerland' },
  'NOR': { nameCN: '挪威', nameEN: 'Norway' },
  'FIN': { nameCN: '芬兰', nameEN: 'Finland' },
  'BEL': { nameCN: '比利时', nameEN: 'Belgium' }
}

// 从位置字符串中提取国家代码
export function extractCountryFromLocation(location: string): string | null {
  if (!location) return null;
  
  // 1. 处理 "CITY, COUNTRY_CODE" 格式
  const commaMatch = location.match(/,\s*([A-Z]{2,3})$/);
  if (commaMatch && commaMatch[1]) {
    return commaMatch[1];
  }
  
  // 2. 处理括号中的国家代码，如 "City (BE)"
  const parenthesesMatch = location.match(/\(([A-Z]{2,3})\)$/);
  if (parenthesesMatch && parenthesesMatch[1]) {
    return parenthesesMatch[1];
  }
  
  // 3. 处理破折号分隔的国家代码，如 "City - BE"
  const dashMatch = location.match(/\s-\s([A-Z]{2,3})$/);
  if (dashMatch && dashMatch[1]) {
    return dashMatch[1];
  }

  // 4. 尝试从文本中提取已知的国家代码
  const words = location.toUpperCase().split(/[\s,.-]+/);
  for (const word of words) {
    if (COUNTRY_CODES[word]) {
      return word;
    }
  }
  
  return null;
}

// 从多个来源识别国家
export function identifyCountry(data: any): { nameCN: string, nameEN: string } | null {
  // 调试日志
  console.log('🔍 开始国家识别:', {
    countryCode: data.countryCode,
    events: data.events,
    destination: data.destination
  });

  // 1. 优先使用API直接返回的国家代码
  if (data.countryCode && COUNTRY_CODES[data.countryCode]) {
    console.log('✅ 使用API返回的国家代码:', data.countryCode);
    return COUNTRY_CODES[data.countryCode];
  }

  // 2. 从事件位置中提取国家信息
  if (data.events && Array.isArray(data.events)) {
    for (const event of data.events) {
      if (event.location) {
        const countryCode = extractCountryFromLocation(event.location);
        if (countryCode && COUNTRY_CODES[countryCode]) {
          console.log('✅ 从事件位置提取到国家代码:', countryCode);
          return COUNTRY_CODES[countryCode];
        }
      }
    }
  }

  // 3. 从目的地信息中提取
  if (data.destination) {
    const countryCode = extractCountryFromLocation(data.destination);
    if (countryCode && COUNTRY_CODES[countryCode]) {
      console.log('✅ 从目的地信息提取到国家代码:', countryCode);
      return COUNTRY_CODES[countryCode];
    }
  }

  // 4. 从原始数据中的其他字段尝试提取
  const possibleFields = ['c', 'w2', 'origin', 'b', 'f'];
  for (const field of possibleFields) {
    if (data[field] && COUNTRY_CODES[data[field]]) {
      console.log(`✅ 从字段 ${field} 找到国家代码:`, data[field]);
      return COUNTRY_CODES[data[field]];
    }
  }

  console.log('❌ 未能识别国家');
  return null;
}

// 获取格式化的国家显示名称
export function getFormattedCountryName(country: { nameCN: string, nameEN: string } | null): string {
  if (!country) {
    return '未知 / Unknown';
  }
  return `${country.nameCN} / ${country.nameEN}`;
}

// 获取国际物流路线显示
export function getLogisticsRoute(originCountry: { nameCN: string, nameEN: string } | null, destCountry: { nameCN: string, nameEN: string } | null): string {
  const origin = getFormattedCountryName(originCountry || { nameCN: '中国', nameEN: 'China' });
  const destination = getFormattedCountryName(destCountry);
  return `${origin} → ${destination}`;
} 